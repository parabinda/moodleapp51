name: Build Ionic Cordova IPA

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-13
    timeout-minutes: 45

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Select Xcode 15.2
        run: sudo xcode-select -s /Applications/Xcode_15.2.app/Contents/Developer

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: Install Ionic and Cordova
        run: npm install -g @ionic/cli cordova

      - name: Install dependencies
        run: npm ci

      - name: Cache Cordova iOS platform
        uses: actions/cache@v4
        with:
          path: platforms/ios
          key: ${{ runner.os }}-cordova-ios-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('config.xml') }}
          restore-keys: |
            ${{ runner.os }}-cordova-ios-

      - name: Add iOS Platform
        run: |
          if [ ! -d "platforms/ios" ]; then
            ionic cordova platform add ios@7.1.1
          else
            echo "iOS platform already cached, skipping..."
          fi

      - name: Cache CocoaPods specs
        uses: actions/cache@v4
        with:
          path: ~/.cocoapods
          key: ${{ runner.os }}-cocoapods-specs-${{ hashFiles('**/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-cocoapods-specs-

      - name: Cache Pods directory
        uses: actions/cache@v4
        with:
          path: platforms/ios/Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('**/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Install CocoaPods dependencies
        working-directory: platforms/ios
        run: |
          if [ ! -d "Pods" ]; then
            pod install
          else
            echo "Pods already cached, skipping pod install..."
          fi

      - name: Cache Xcode DerivedData
        uses: actions/cache@v4
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-xcode-derived-${{ hashFiles('**/Podfile.lock') }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-xcode-derived-

      - name: Patch signing into xcodeproj
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          PBXPROJ="platforms/ios/EVidya.xcodeproj/project.pbxproj"
          sed -i '' "s/DEVELOPMENT_TEAM = [^;]*;/DEVELOPMENT_TEAM = $APPLE_TEAM_ID;/g" "$PBXPROJ"
          sed -i '' 's/CODE_SIGN_IDENTITY = [^;]*;/CODE_SIGN_IDENTITY = "";/g' "$PBXPROJ"
          sed -i '' 's/CODE_SIGNING_REQUIRED = [^;]*;/CODE_SIGNING_REQUIRED = NO;/g' "$PBXPROJ"
          sed -i '' 's/CODE_SIGNING_ALLOWED = [^;]*;/CODE_SIGNING_ALLOWED = NO;/g' "$PBXPROJ"
          sed -i '' 's/PROVISIONING_PROFILE_SPECIFIER = [^;]*;/PROVISIONING_PROFILE_SPECIFIER = "";/g' "$PBXPROJ"
          echo "--- Verify patch ---"
          grep -E "DEVELOPMENT_TEAM|CODE_SIGN|PROVISIONING" "$PBXPROJ" | head -20

      - name: Sanity check before build
        run: |
          echo "--- Xcode version ---"
          xcodebuild -version
          echo "--- Team ID in pbxproj ---"
          grep "DEVELOPMENT_TEAM" \
            platforms/ios/EVidya.xcodeproj/project.pbxproj | head -5

      # KEY CHANGE: bypass Ionic/Cordova CLI entirely, call xcodebuild directly
      - name: Build iOS Project (Debug)
        run: |
          cd platforms/ios
          xcodebuild \
            -workspace EVidya.xcworkspace \
            -scheme EVidya \
            -configuration Debug \
            -destination generic/platform=iOS \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            DEVELOPMENT_TEAM=${{ secrets.APPLE_TEAM_ID }} \
            CODE_SIGN_ENTITLEMENTS="" \
            PROVISIONING_PROFILE="" \
            build

      - name: Package IPA
        working-directory: platforms/ios
        run: |
          # xcodebuild output goes to derivedDataPath/Build/Products/
          APP_PATH=$(find build -name "*.app" \
            -not -path "*/Simulator/*" \
            -not -path "*/simulator/*" | head -1)

          if [ -z "$APP_PATH" ]; then
            echo "ERROR: No .app found. Listing for debug:"
            find build -name "*.app" | head -20
            exit 1
          fi

          echo "Found app at: $APP_PATH"
          mkdir -p Payload
          cp -r "$APP_PATH" Payload/
          zip -r EVidyaIos.ipa Payload/
          mv EVidyaIos.ipa ../../EVidyaIos.ipa

      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-debug-ipa
          path: EVidyaIos.ipa
          retention-days: 7
